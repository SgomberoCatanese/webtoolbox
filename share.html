<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate="page_title">Condividi File Online - WebToolbox.fun</title>
  <meta name="description" data-translate="page_description" content="Condividi file di qualsiasi tipo e dimensione online direttamente tra dispositivi (P2P). Crea un codice univoco e trasferisci file in modo sicuro." />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  
  <style>
    /*
      Stile CSS con estetica iOS e logica mobile avanzata
      Supporto per tema chiaro/scuro (STILE INVARIATO COME RICHIESTO)
    */

    /* Reset e Stili Globali */
    :root {
      /* Tema Scuro (default) */
      --bg-primary: #000000; --bg-secondary: #1C1C1E; --bg-tertiary: #2C2C2E; --text-primary: #F2F2F7; --text-secondary: #AEAEB2; --text-tertiary: #8E8E93; --accent-color: #0A84FF; --border-color: rgba(84, 84, 88, 0.65); --nav-bg: rgba(28, 28, 30, 0.75); --card-bg: #1C1C1E; --input-bg: #2C2C2E; --success-color: #30D158; --warning-color: #FF9F0A; --error-color: #FF453A; --gradient-bg: linear-gradient(135deg, rgba(10, 132, 255, 0.1) 0%, rgba(48, 209, 88, 0.1) 100%);
    }

    [data-theme="light"] {
      /* Tema Chiaro */
      --bg-primary: #FFFFFF; --bg-secondary: #F2F2F7; --bg-tertiary: #E5E5EA; --text-primary: #000000; --text-secondary: #3A3A3C; --text-tertiary: #6D6D70; --accent-color: #007AFF; --border-color: rgba(60, 60, 67, 0.29); --nav-bg: rgba(248, 248, 248, 0.94); --card-bg: #FFFFFF; --input-bg: #F2F2F7; --success-color: #34C759; --warning-color: #FF9500; --error-color: #FF3B30; --gradient-bg: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(52, 199, 89, 0.1) 100%);
    }

    body { background: var(--bg-primary); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
    nav { background: var(--nav-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-bottom: 0.5px solid var(--border-color); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 20; }
    nav .logo { font-weight: 600; font-size: 1.1rem; color: var(--text-primary); }
    nav ul { display: flex; gap: 1.5rem; list-style: none; flex-wrap: wrap; margin: 0; }
    nav a { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: opacity 0.2s ease-in-out; }
    nav a:hover { opacity: 0.7; }
    nav a.active { color: var(--text-primary); font-weight: 600; }
    #mobile-menu-trigger { display: none; }
    .nav-controls { display: flex; align-items: center; gap: 1rem; }
    .theme-toggle, .lang-selector { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
    .theme-toggle:hover, .lang-selector:hover { background: var(--bg-tertiary); }
    main { max-width: 900px; margin: 2rem auto; padding: 0 1.5rem 4rem 1.5rem; width: 100%; box-sizing: border-box; flex: 1; }
    h1 { text-align: center; margin-bottom: 0.5rem; font-size: 2.5rem; font-weight: 700; }
    .subtitle { text-align: center; margin-bottom: 2.5rem; color: var(--text-secondary); line-height: 1.5; }
    .tab-container { display: flex; background: var(--card-bg); border-radius: 16px; padding: 4px; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    .tab { flex: 1; padding: 1rem; text-align: center; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; color: var(--text-secondary); }
    .tab.active { background: var(--accent-color); color: #FFFFFF; transform: scale(1.02); }
    .content-section { display: none; animation: fadeIn 0.3s ease-in-out; }
    .content-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .main-card { background: var(--card-bg); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }
    .upload-area { border: 2px dashed var(--border-color); border-radius: 20px; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--gradient-bg); margin-bottom: 2rem; }
    .upload-area:hover, .upload-area.dragover { border-color: var(--accent-color); background: var(--gradient-bg); transform: scale(1.02); }
    .upload-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--accent-color); }
    .upload-text { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
    .upload-subtext { color: var(--text-secondary); font-size: 0.9rem; }
    .file-info { background: var(--input-bg); border-radius: 16px; padding: 1.5rem; margin: 1rem 0; display: none; }
    .file-info.show { display: block; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    .file-name { font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); word-break: break-all; }
    .file-size { color: var(--text-secondary); font-size: 0.9rem; }
    .form-group { margin-bottom: 1.5rem; text-align: left; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
    .form-group input, .form-group textarea { width: 100%; padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-family: inherit; font-size: 1rem; box-sizing: border-box; transition: all 0.2s ease; }
    .form-group textarea { resize: vertical; min-height: 120px; font-family: monospace; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); }
    .btn { background: var(--accent-color); border: none; color: #FFFFFF; padding: 1rem 2rem; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 1rem; font-family: inherit; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; min-width: 150px; }
    .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
    .btn:disabled { background: var(--text-tertiary); cursor: not-allowed; transform: none; filter: none; }
    .btn-secondary { background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-success { background: var(--success-color); }
    .btn-full { width: 100%; margin: 1rem 0; }
    .status-message { padding: 1rem; border-radius: 12px; margin: 1rem 0; text-align: center; font-weight: 500; display: none; }
    .status-success { background: rgba(48, 209, 88, 0.1); color: var(--success-color); border: 1px solid var(--success-color); }
    .status-error { background: rgba(255, 69, 58, 0.1); color: var(--error-color); border: 1px solid var(--error-color); }
    .status-info { background: rgba(10, 132, 255, 0.1); color: var(--accent-color); border: 1px solid var(--accent-color); }
    .progress-container { background: var(--input-bg); border-radius: 10px; height: 10px; margin: 1rem 0; overflow: hidden; display: none; }
    .progress-bar { background: var(--accent-color); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px; }
    .hidden { display: none !important; }
    input[type="file"] { display: none; }
    @media (max-width: 768px) { nav ul { display: none; position: absolute; top: 65px; right: 1.5rem; width: 250px; background: var(--nav-bg); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); border-radius: 14px; border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); padding: 0.5rem 0; flex-direction: column; gap: 0; z-index: 100; } nav ul.mobile-menu-active { display: flex; } nav ul li { width: 100%; } nav ul li a { display: block; padding: 0.9rem 1.25rem; color: var(--text-primary); font-weight: 400; border-bottom: 0.5px solid var(--border-color); } nav ul li:last-child a { border-bottom: none; } nav ul li a.active { background-color: var(--accent-color); color: #FFFFFF; } #mobile-menu-trigger { display: block; background: none; border: none; padding: 0.5rem; cursor: pointer; } #mobile-menu-trigger svg { width: 24px; height: 24px; fill: var(--accent-color); } h1 { font-size: 2rem; } main { padding: 0 1rem 4rem 1rem; } .main-card { padding: 1.5rem; } .upload-area { padding: 2rem 1rem; } .nav-controls { gap: 0.5rem; } .theme-toggle, .lang-selector { padding: 0.4rem; font-size: 0.8rem; } }
    .bounce { animation: bounce 0.5s ease; }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
  </style>
</head>
<body>
<nav>
  <div class="logo">üß∞ WebToolbox.fun</div>
  <ul>
    <li><a href="index.html">Converti</a></li>
    <li><a href="share.html" class="active" data-translate="nav_share">Condividi</a></li>
  </ul>
  <div class="nav-controls">
    <select class="lang-selector" id="langSelector">
      <option value="it">üáÆüáπ IT</option>
      <option value="en">üá¨üáß EN</option>
      <option value="fr">üá´üá∑ FR</option>
      <option value="de">üá©üá™ DE</option>
      <option value="es">üá™üá∏ ES</option>
    </select>
    <button class="theme-toggle" id="themeToggle">üåô</button>
  </div>
  <button id="mobile-menu-trigger" aria-label="Apri menu">
    <svg viewBox="0 0 100 80" width="40" height="40"><circle cx="50" cy="10" r="8"/><circle cx="50" cy="40" r="8"/><circle cx="50" cy="70" r="8"/></svg>
  </button>
</nav>

<main>
  <h1 data-translate="title">Condivisione File Diretta</h1>
  <p class="subtitle" data-translate="subtitle">Trasferisci file P2P, senza server intermedi. Veloce, privato e sicuro.</p>

  <div class="tab-container">
    <div class="tab active" id="sendTab" data-translate="send_tab">üì§ Invia</div>
    <div class="tab" id="receiveTab" data-translate="receive_tab">üì• Ricevi</div>
  </div>

  <div class="content-section active" id="sendSection">
    <div class="main-card" id="sendCard1">
      <h3 data-translate="send_step1_title">Step 1: Seleziona un File</h3>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text" data-translate="upload_text">Trascina il file qui o clicca</div>
        <div class="upload-subtext" data-translate="upload_subtext">Nessun limite di dimensione</div>
      </div>
      <input type="file" id="fileInput" />
      <div class="file-info" id="fileInfo">
        <div class="file-name" id="fileName"></div>
        <div class="file-size" id="fileSize"></div>
      </div>
      <button class="btn btn-full" id="generateOfferBtn" disabled data-translate="generate_offer_btn">Genera Codice di Invio</button>
    </div>

    <div class="main-card hidden" id="sendCard2">
        <h3 data-translate="send_step2_title">Step 2: Invia questo codice al destinatario</h3>
        <div class="form-group">
            <textarea id="offerCode" readonly></textarea>
        </div>
        <button class="btn btn-secondary" id="copyOfferBtn" data-translate="copy_code">üìã Copia Codice</button>
    </div>

    <div class="main-card hidden" id="sendCard3">
        <h3 data-translate="send_step3_title">Step 3: Incolla il codice di risposta</h3>
        <div class="form-group">
            <textarea id="answerCode" data-translate-placeholder="answer_code_placeholder" placeholder="Il destinatario ti invier√† un codice..."></textarea>
        </div>
        <button class="btn" id="connectBtn" data-translate="connect_btn">Connetti e Invia</button>
    </div>
    
    <div class="main-card hidden" id="sendProgressCard">
        <h3 data-translate="sending_file">Invio del file in corso...</h3>
        <p id="sendingFileName" class="subtitle"></p>
        <div class="progress-container" style="display: block;">
            <div class="progress-bar" id="sendProgressBar"></div>
        </div>
        <div class="status-message" id="sendStatusMessage"></div>
    </div>
  </div>

  <div class="content-section" id="receiveSection">
    <div class="main-card" id="receiveCard1">
      <h3 data-translate="receive_step1_title">Step 1: Incolla il codice di invio</h3>
      <div class="form-group">
        <textarea id="offerPaste" data-translate-placeholder="offer_paste_placeholder" placeholder="Incolla il codice che hai ricevuto..."></textarea>
      </div>
      <button class="btn btn-full" id="generateAnswerBtn" data-translate="generate_answer_btn">Genera Codice di Risposta</button>
    </div>

    <div class="main-card hidden" id="receiveCard2">
        <h3 data-translate="receive_step2_title">Step 2: Invia questo codice al mittente</h3>
        <div class="form-group">
            <textarea id="answerCodeGenerated" readonly></textarea>
        </div>
        <button class="btn btn-secondary" id="copyAnswerBtn" data-translate="copy_code">üìã Copia Codice</button>
        <p class="subtitle" data-translate="receive_step2_desc">Attendi che il mittente si connetta. Il download partir√† in automatico.</p>
    </div>

    <div class="main-card hidden" id="receiveProgressCard">
        <h3 data-translate="receiving_file">Ricezione del file in corso...</h3>
        <div class="file-info show">
            <div class="file-name" id="receiveFileName"></div>
            <div class="file-size" id="receiveFileSize"></div>
        </div>
        <div class="progress-container" style="display: block;">
            <div class="progress-bar" id="receiveProgressBar"></div>
        </div>
        <div class="status-message" id="receiveStatusMessage"></div>
    </div>
  </div>
</main>

<script>
// --- VARIABILI GLOBALI E STATO ---
let peer;
let currentFile;
let receivedFileData = { name: '', size: 0, type: '' };
let receivedChunks = [];
let receivedSize = 0;
const CHUNK_SIZE = 64 * 1024; // 64KB per chunk

// --- TRADUZIONI ---
const translations = {
  it: {
    page_title: "Condividi File Online - WebToolbox.fun",
    page_description: "Condividi file di qualsiasi tipo e dimensione online direttamente tra dispositivi (P2P). Crea un codice univoco e trasferisci file in modo sicuro.",
    nav_share: "Condividi",
    title: "Condivisione File Diretta",
    subtitle: "Trasferisci file P2P, senza server intermedi. Veloce, privato e sicuro.",
    send_tab: "üì§ Invia",
    receive_tab: "üì• Ricevi",
    send_step1_title: "Step 1: Seleziona un File",
    upload_text: "Trascina il file qui o clicca",
    upload_subtext: "Nessun limite di dimensione",
    generate_offer_btn: "Genera Codice di Invio",
    send_step2_title: "Step 2: Invia questo codice al destinatario",
    copy_code: "üìã Copia Codice",
    send_step3_title: "Step 3: Incolla il codice di risposta",
    answer_code_placeholder: "Il destinatario ti invier√† un codice...",
    connect_btn: "Connetti e Invia",
    sending_file: "Invio del file in corso...",
    receive_step1_title: "Step 1: Incolla il codice di invio",
    offer_paste_placeholder: "Incolla il codice che hai ricevuto...",
    generate_answer_btn: "Genera Codice di Risposta",
    receive_step2_title: "Step 2: Invia questo codice al mittente",
    receive_step2_desc: "Attendi che il mittente si connetta. Il download partir√† in automatico.",
    receiving_file: "Ricezione del file in corso...",
    status_connected: "‚úÖ Connesso! Trasferimento in corso...",
    status_error: "‚ùå Errore di connessione: ",
    status_closed: "üîå Connessione chiusa.",
    status_file_sent: "‚úÖ File inviato con successo!",
    status_file_received: "‚úÖ File ricevuto! Download avviato.",
    status_invalid_code: "Codice non valido. Riprova.",
  },
  en: {
    page_title: "Share Files Online - WebToolbox.fun",
    page_description: "Share files of any type and size online directly between devices (P2P). Create a unique code and transfer files securely.",
    nav_share: "Share",
    title: "Direct File Sharing",
    subtitle: "Transfer files P2P, without intermediate servers. Fast, private, and secure.",
    send_tab: "üì§ Send",
    receive_tab: "üì• Receive",
    send_step1_title: "Step 1: Select a File",
    upload_text: "Drag file here or click",
    upload_subtext: "No size limits",
    generate_offer_btn: "Generate Send Code",
    send_step2_title: "Step 2: Send this code to the recipient",
    copy_code: "üìã Copy Code",
    send_step3_title: "Step 3: Paste the answer code",
    answer_code_placeholder: "The recipient will send you a code...",
    connect_btn: "Connect and Send",
    sending_file: "Sending file...",
    receive_step1_title: "Step 1: Paste the send code",
    offer_paste_placeholder: "Paste the code you received...",
    generate_answer_btn: "Generate Answer Code",
    receive_step2_title: "Step 2: Send this code to the sender",
    receive_step2_desc: "Wait for the sender to connect. The download will start automatically.",
    receiving_file: "Receiving file...",
    status_connected: "‚úÖ Connected! Transfer in progress...",
    status_error: "‚ùå Connection error: ",
    status_closed: "üîå Connection closed.",
    status_file_sent: "‚úÖ File sent successfully!",
    status_file_received: "‚úÖ File received! Download started.",
    status_invalid_code: "Invalid code. Please try again.",
  },
  // Aggiungere qui le altre lingue (fr, de, es) se necessario
  fr: { /* ... */ }, de: { /* ... */ }, es: { /* ... */ }
};

// --- ELEMENTI DEL DOM ---
const elements = {
    sendTab: document.getElementById('sendTab'),
    receiveTab: document.getElementById('receiveTab'),
    sendSection: document.getElementById('sendSection'),
    receiveSection: document.getElementById('receiveSection'),
    uploadArea: document.getElementById('uploadArea'),
    fileInput: document.getElementById('fileInput'),
    fileInfo: document.getElementById('fileInfo'),
    fileName: document.getElementById('fileName'),
    fileSize: document.getElementById('fileSize'),
    generateOfferBtn: document.getElementById('generateOfferBtn'),
    sendCard1: document.getElementById('sendCard1'),
    sendCard2: document.getElementById('sendCard2'),
    sendCard3: document.getElementById('sendCard3'),
    offerCode: document.getElementById('offerCode'),
    copyOfferBtn: document.getElementById('copyOfferBtn'),
    answerCode: document.getElementById('answerCode'),
    connectBtn: document.getElementById('connectBtn'),
    sendProgressCard: document.getElementById('sendProgressCard'),
    sendingFileName: document.getElementById('sendingFileName'),
    sendProgressBar: document.getElementById('sendProgressBar'),
    sendStatusMessage: document.getElementById('sendStatusMessage'),
    receiveCard1: document.getElementById('receiveCard1'),
    receiveCard2: document.getElementById('receiveCard2'),
    offerPaste: document.getElementById('offerPaste'),
    generateAnswerBtn: document.getElementById('generateAnswerBtn'),
    answerCodeGenerated: document.getElementById('answerCodeGenerated'),
    copyAnswerBtn: document.getElementById('copyAnswerBtn'),
    receiveProgressCard: document.getElementById('receiveProgressCard'),
    receiveFileName: document.getElementById('receiveFileName'),
    receiveFileSize: document.getElementById('receiveFileSize'),
    receiveProgressBar: document.getElementById('receiveProgressBar'),
    receiveStatusMessage: document.getElementById('receiveStatusMessage'),
    langSelector: document.getElementById('langSelector'),
    themeToggle: document.getElementById('themeToggle')
};

// --- INIZIALIZZAZIONE ---
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    setupEventListeners();
});

function initializeApp() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.setAttribute('data-theme', 'light');
        elements.themeToggle.textContent = '‚òÄÔ∏è';
    }

    const savedLang = localStorage.getItem('language') || 'it';
    elements.langSelector.value = savedLang;
    updateLanguage(savedLang);
}

function setupEventListeners() {
    // Navigazione Tab
    elements.sendTab.addEventListener('click', switchToSend);
    elements.receiveTab.addEventListener('click', switchToReceive);

    // Area di Upload
    elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        elements.uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        elements.uploadArea.addEventListener(eventName, () => elements.uploadArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        elements.uploadArea.addEventListener(eventName, () => elements.uploadArea.classList.remove('dragover'), false);
    });
    elements.uploadArea.addEventListener('drop', handleDrop, false);
    elements.fileInput.addEventListener('change', handleFileSelect);

    // Pulsanti
    elements.generateOfferBtn.addEventListener('click', handleGenerateOffer);
    elements.connectBtn.addEventListener('click', handleConnect);
    elements.generateAnswerBtn.addEventListener('click', handleGenerateAnswer);
    elements.copyOfferBtn.addEventListener('click', () => copyToClipboard(elements.offerCode.value));
    elements.copyAnswerBtn.addEventListener('click', () => copyToClipboard(elements.answerCodeGenerated.value));

    // Controlli UI
    elements.langSelector.addEventListener('change', (e) => {
        const lang = e.target.value;
        localStorage.setItem('language', lang);
        updateLanguage(lang);
    });
    elements.themeToggle.addEventListener('click', toggleTheme);
    setupMobileMenu();
}

// --- LOGICA UI ---
function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
function switchToSend() { elements.sendTab.classList.add('active'); elements.receiveTab.classList.remove('active'); elements.sendSection.classList.add('active'); elements.receiveSection.classList.remove('active'); }
function switchToReceive() { elements.receiveTab.classList.add('active'); elements.sendTab.classList.remove('active'); elements.receiveSection.classList.add('active'); elements.sendSection.classList.remove('active'); }

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) handleFile(files[0]);
}

function handleFileSelect(e) {
    if (e.target.files.length) handleFile(e.target.files[0]);
}

function handleFile(file) {
    currentFile = file;
    elements.fileName.textContent = file.name;
    elements.fileSize.textContent = formatFileSize(file.size);
    elements.fileInfo.classList.add('show');
    elements.generateOfferBtn.disabled = false;
    elements.fileInfo.classList.add('bounce');
    setTimeout(() => elements.fileInfo.classList.remove('bounce'), 500);
}

// --- LOGICA WEBRTC (PEER-TO-PEER) ---

function initializePeer(isInitiator) {
    if (peer) peer.destroy(); // Distrugge la vecchia connessione se esiste

    peer = new SimplePeer({
        initiator: isInitiator,
        trickle: false, // Semplifica lo scambio di segnali a un unico blocco
    });

    peer.on('error', err => showStatusMessage(isInitiator ? elements.sendStatusMessage : elements.receiveStatusMessage, 'error', getTranslation('status_error') + err.message));
    peer.on('close', () => showStatusMessage(isInitiator ? elements.sendStatusMessage : elements.receiveStatusMessage, 'info', getTranslation('status_closed')));

    peer.on('signal', data => {
        const signalString = btoa(JSON.stringify(data)); // Codifica in Base64 per facilitare il copia/incolla
        if (isInitiator) {
            elements.offerCode.value = signalString;
            elements.sendCard1.classList.add('hidden');
            elements.sendCard2.classList.remove('hidden');
            elements.sendCard3.classList.remove('hidden');
        } else {
            elements.answerCodeGenerated.value = signalString;
            elements.receiveCard1.classList.add('hidden');
            elements.receiveCard2.classList.remove('hidden');
        }
    });

    peer.on('connect', () => {
        if (isInitiator) {
            elements.sendCard2.classList.add('hidden');
            elements.sendCard3.classList.add('hidden');
            elements.sendProgressCard.classList.remove('hidden');
            showStatusMessage(elements.sendStatusMessage, 'success', getTranslation('status_connected'));
            sendFile();
        } else {
            showStatusMessage(elements.receiveStatusMessage, 'success', getTranslation('status_connected'));
        }
    });

    peer.on('data', data => handleReceivedData(data));
}

// Mittente
function handleGenerateOffer() {
    if (!currentFile) return;
    initializePeer(true);
}

function handleConnect() {
    try {
        const answer = JSON.parse(atob(elements.answerCode.value));
        peer.signal(answer);
    } catch (e) {
        alert(getTranslation('status_invalid_code'));
    }
}

function sendFile() {
    elements.sendingFileName.textContent = currentFile.name;
    const fileMetadata = { name: currentFile.name, size: currentFile.size, type: currentFile.type };
    peer.send(JSON.stringify({ type: 'metadata', payload: fileMetadata }));

    let offset = 0;
    const reader = new FileReader();

    reader.onload = (e) => {
        peer.send(e.target.result);
        offset += e.target.result.byteLength;
        updateProgressBar(elements.sendProgressBar, offset, currentFile.size);
        if (offset < currentFile.size) {
            readSlice(offset);
        } else {
            showStatusMessage(elements.sendStatusMessage, 'success', getTranslation('status_file_sent'));
        }
    };

    const readSlice = (o) => {
        const slice = currentFile.slice(o, o + CHUNK_SIZE);
        reader.readAsArrayBuffer(slice);
    };
    readSlice(0);
}

// Ricevente
function handleGenerateAnswer() {
    try {
        const offer = JSON.parse(atob(elements.offerPaste.value));
        initializePeer(false);
        peer.signal(offer);
    } catch (e) {
        alert(getTranslation('status_invalid_code'));
    }
}

function handleReceivedData(data) {
    try {
        const message = JSON.parse(data);
        if (message.type === 'metadata') {
            receivedFileData = message.payload;
            elements.receiveCard2.classList.add('hidden');
            elements.receiveProgressCard.classList.remove('hidden');
            elements.receiveFileName.textContent = receivedFileData.name;
            elements.receiveFileSize.textContent = formatFileSize(receivedFileData.size);
            return;
        }
    } catch (e) {
        // Se non √® JSON, √® un chunk di file
        receivedChunks.push(data);
        receivedSize += data.byteLength;
        updateProgressBar(elements.receiveProgressBar, receivedSize, receivedFileData.size);

        if (receivedSize === receivedFileData.size) {
            const fileBlob = new Blob(receivedChunks, { type: receivedFileData.type });
            showStatusMessage(elements.receiveStatusMessage, 'success', getTranslation('status_file_received'));
            downloadBlob(fileBlob, receivedFileData.name);
            // Resetta per un nuovo trasferimento
            receivedChunks = [];
            receivedSize = 0;
        }
    }
}

// --- FUNZIONI DI UTILIT√Ä ---
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
}

function updateProgressBar(barElement, current, total) {
    const percentage = total > 0 ? (current / total) * 100 : 0;
    barElement.style.width = `${percentage}%`;
}

function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

function showStatusMessage(element, type, message) {
    element.className = `status-message status-${type}`;
    element.textContent = message;
    element.style.display = 'block';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Copiato!');
    }).catch(err => {
        console.error('Errore copia:', err);
    });
}

function toggleTheme() {
    const isLight = document.body.hasAttribute('data-theme');
    if (isLight) {
        document.body.removeAttribute('data-theme');
        elements.themeToggle.textContent = 'üåô';
        localStorage.setItem('theme', 'dark');
    } else {
        document.body.setAttribute('data-theme', 'light');
        elements.themeToggle.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'light');
    }
}

function updateLanguage(lang) {
    const t = translations[lang] || translations.it;
    document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (t[key]) el.textContent = t[key];
    });
    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        if (t[key]) el.placeholder = t[key];
    });
}

function getTranslation(key) {
    const lang = elements.langSelector.value || 'it';
    return (translations[lang] && translations[lang][key]) || translations.it[key];
}

function setupMobileMenu() {
  const mobileMenuTrigger = document.getElementById('mobile-menu-trigger');
  const navUl = document.querySelector('nav ul');
  if (mobileMenuTrigger && navUl) {
    mobileMenuTrigger.addEventListener('click', (e) => { e.stopPropagation(); navUl.classList.toggle('mobile-menu-active'); });
    document.addEventListener('click', (e) => { if (navUl.classList.contains('mobile-menu-active') && !navUl.contains(e.target)) { navUl.classList.remove('mobile-menu-active'); } });
  }
}
</script>
</body>
</html>
