<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate-key="pageTitle">Convertitore Immagini Pro ‚Äì WebToolbox.fun</title>
  <meta name="description" content="Converti immagini con un'interfaccia avanzata ispirata a iOS. Supporta drag-and-drop, 12 lingue, temi multipli e animazioni fluide." data-translate-key="metaDescription" />
  <style>
    /*
      Stile CSS v5.0 FINAL - Lista Formati Completa, Fallback Intelligente e Notifiche Toast
    */
    :root { /* Tema Scuro (Default) */
      --bg-primary: #1C1C1E;
      --bg-secondary: #2C2C2E;
      --bg-tertiary: #3A3A3C;
      --bg-modal-backdrop: rgba(0, 0, 0, 0.6);
      --bg-modal: rgba(40, 40, 42, 0.9);
      --text-primary: #FFFFFF;
      --text-secondary: #EBEBF599;
      --text-tertiary: #EBEBF566;
      --accent-primary: #0A84FF;
      --accent-secondary: #FF9F0A;
      --accent-destructive: #FF453A;
      --separator-color: #38383A;
      --separator-modal: #545458A6;
      --nav-bg: rgba(28, 28, 30, 0.8);
      --shadow-color: rgba(0, 0, 0, 0.5);
      --glow-color: rgba(10, 132, 255, 0.8);
    }
    [data-theme="light"] {
      --bg-primary: #F2F2F7;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #E5E5EA;
      --bg-modal-backdrop: rgba(0, 0, 0, 0.3);
      --bg-modal: rgba(245, 245, 247, 0.9);
      --text-primary: #000000;
      --text-secondary: #3C3C4399;
      --text-tertiary: #3C3C4366;
      --accent-primary: #007AFF;
      --accent-secondary: #FF9500;
      --accent-destructive: #FF3B30;
      --separator-color: #C6C6C8;
      --separator-modal: #3C3C434A;
      --nav-bg: rgba(249, 249, 249, 0.8);
      --shadow-color: rgba(0, 0, 0, 0.08);
      --glow-color: rgba(0, 122, 255, 0.7);
    }
    [data-theme="midnight"] {
      --bg-primary: #000000;
      --bg-secondary: #1D1D1F;
      --bg-tertiary: #2C2C2E;
      --text-primary: #FFFFFF;
      --accent-primary: #0A84FF;
      --shadow-color: rgba(0, 0, 0, 0.6);
      --nav-bg: rgba(0, 0, 0, 0.75);
    }
    [data-theme="slate"] {
      --bg-primary: #29313E;
      --bg-secondary: #354152;
      --bg-tertiary: #495867;
      --text-primary: #F7F7F7;
      --accent-primary: #F9A03F;
      --accent-destructive: #E54B4B;
      --separator-color: #495867;
      --nav-bg: rgba(25, 32, 41, 0.8);
      --glow-color: rgba(249, 160, 63, 0.7);
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      transition: background 0.4s, color 0.4s;
    }
    body.no-scroll { overflow: hidden; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 var(--glow-color); } 70% { box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes glow-border {
      0%, 100% { box-shadow: 0 0 5px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--accent-primary); }
      50% { box-shadow: 0 0 20px var(--glow-color), inset 0 0 10px var(--glow-color); border-color: var(--accent-primary); }
    }
    @keyframes progressGlow {
      0% { box-shadow: 0 0 5px var(--accent-primary); }
      50% { box-shadow: 0 0 20px var(--accent-primary); }
      100% { box-shadow: 0 0 5px var(--accent-primary); }
    }
    
    nav {
      background: var(--nav-bg);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 0.5px solid var(--separator-color);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    nav .logo { 
      font-weight: 600; 
      color: var(--text-primary); 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
    }
    nav .logo img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      object-fit: cover;
    }
    nav .nav-title-scrolled {
      font-weight: 600;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    nav .desktop-nav { display: flex; gap: 1.5rem; list-style: none; margin: 0; padding: 0; }
    nav a { color: var(--accent-primary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    nav a:hover { color: var(--text-primary); }
    nav a.active { color: var(--text-primary); font-weight: 600; }
    .nav-controls { display: flex; align-items: center; gap: 0.75rem; }
    
    #mobile-menu-trigger, #mobile-menu-close {
      display: none; background: none; border: none; cursor: pointer;
      padding: 0.5rem; color: var(--accent-primary); z-index: 110;
    }
    #mobile-menu-close { position: absolute; top: 1rem; right: 1.5rem; }
    #mobile-menu-trigger svg, #mobile-menu-close svg { width: 28px; height: 28px; }

    .mobile-nav {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-modal);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      z-index: 100; display: flex; flex-direction: column;
      padding: 6rem 1.5rem 2rem;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .mobile-nav.active { transform: translateX(0); }
    .mobile-nav ul { list-style: none; padding: 0; margin: 0; width: 100%; }
    .mobile-nav ul a {
      display: flex; align-items: center; gap: 1rem; font-size: 1.25rem; padding: 1rem;
      color: var(--text-primary); font-weight: 500; border-bottom: 0.5px solid var(--separator-color);
    }
    .mobile-nav ul a svg { width: 24px; height: 24px; color: var(--accent-primary); }
    .mobile-nav ul li:first-child a { border-top: 0.5px solid var(--separator-color); }
    .mobile-nav .nav-controls { margin-top: auto; justify-content: center; width: 100%; display: flex; gap: 1rem; }
    
    .content-wrapper { max-width: 800px; margin: 0 auto; padding: 0 1.5rem 4rem; }
    header.main-header { padding-top: 1rem; }
    header.main-header h1 { font-size: 2.5rem; font-weight: 700; margin: 0; transition: opacity 0.2s ease-in-out; }
    p.description { margin: 0.5rem 0 2.5rem 0; color: var(--text-secondary); line-height: 1.5; font-size: 1.1rem; }
    
    .ios-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      box-shadow: 0 4px 20px var(--shadow-color);
      transition: background 0.4s, box-shadow 0.4s;
    }
    .ios-list > * { padding: 1rem 1.25rem; }
    .ios-list > :not(:last-child) { border-bottom: 0.5px solid var(--separator-color); }
    .ios-list label { display: flex; justify-content: space-between; align-items: center; font-weight: 500; }

    #dropZone {
      border: 2px dashed var(--bg-tertiary); border-radius: 18px; padding: 3rem 1rem; text-align: center;
      color: var(--text-secondary); cursor: pointer; transition: all 0.3s ease-in-out; margin: 1.5rem; position: relative;
    }
    #dropZone:hover { border-color: var(--accent-primary); background: var(--bg-tertiary); }
    #dropZone.drag-glow { border-style: solid; animation: glow-border 1.5s infinite; }
    #dropZone .upload-icon { width: 40px; height: 40px; margin-bottom: 1rem; color: var(--text-secondary); transition: color 0.2s; }
    #dropZone:hover .upload-icon { color: var(--accent-primary); }
    #dropZone p { margin: 0; font-weight: 500; }
    #dropZone p span { color: var(--accent-primary); font-weight: 600; }
    input[type="file"] { display: none; }
    
    select {
      padding: 0.7rem 1rem; border-radius: 8px; border: none; font-weight: 500; cursor: pointer;
      background-color: var(--bg-tertiary); color: var(--text-primary); font-family: inherit; font-size: 1rem;
      -webkit-appearance: none; appearance: none; transition: background 0.4s;
    }
    select#outputFormat { max-height: 150px; overflow-y: auto; text-align: right; }
    
    button#convertBtn {
      width: 100%; border: none; background: var(--accent-primary); color: white; font-size: 1.1rem;
      font-weight: 600; padding: 0.9rem; border-radius: 8px; cursor: pointer;
      transition: transform 0.2s, filter 0.2s; position: relative; overflow: hidden;
    }
    button#convertBtn:hover { filter: brightness(1.1); }
    button#convertBtn:active { transform: scale(0.98); }
    button#convertBtn.pulsing { animation: pulse-glow 2s infinite; }
    button#convertBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Progress Bar Styles */
    .progress-container {
      position: relative;
      width: 100%;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      margin: 1rem 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
      animation: progressGlow 2s infinite;
    }
    .progress-text {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: none;
    }

    #previewContainer { display: flex; flex-wrap: wrap; gap: 15px; padding: 1.5rem; justify-content: center; }
    #previewContainer img { height: 120px; border-radius: 12px; object-fit: contain; animation: fadeInUp 0.5s cubic-bezier(0.25, 1, 0.5, 1) both; }
    
    #resultContainer { margin-top: 2rem; }
    #resultContainer .ios-card { padding: 1rem; text-align: center; animation: fadeInUp 0.5s; }
    #resultContainer img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 1rem; }
    #resultContainer a { font-weight: 500; color: var(--accent-primary); text-decoration: none; font-size: 1.1rem; }

    #toastContainer {
        position: fixed;
        top: calc(env(safe-area-inset-top, 0) + 1rem);
        left: 50%;
        transform: translateX(-50%);
        z-index: 300;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        width: fit-content;
        max-width: 90%;
    }
    .toast {
      display: flex; align-items: center; gap: 0.75rem; color: var(--text-primary); background: var(--bg-modal);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      padding: 0.8rem 1.2rem; border-radius: 50px; font-size: 0.9rem; font-weight: 500;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      animation: slideInDown 0.4s cubic-bezier(0.25, 1, 0.5, 1), fadeOut 0.4s 4.5s forwards;
    }
    .toast svg { width: 20px; height: 20px; color: var(--accent-secondary); }

    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-modal-backdrop);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 200; display: flex; justify-content: center; align-items: center;
      opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
      animation: fadeIn 0.3s;
    }
    .modal-backdrop.visible { opacity: 1; visibility: visible; }
    .modal-dialog {
      background: var(--bg-modal); border-radius: 14px; text-align: center;
      max-width: 280px; width: 90%; padding-top: 1.25rem;
      animation: zoomIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .modal-dialog h3 { margin: 0 1rem 0.5rem; font-size: 1.1rem; font-weight: 600; }
    .modal-dialog p { margin: 0 1rem 1.25rem; font-size: 0.9rem; color: var(--text-secondary); }
    .modal-buttons { display: flex; border-top: 0.5px solid var(--separator-modal); }
    .modal-buttons button {
      flex: 1; background: none; border: none; padding: 0.8rem;
      font-size: 1.1rem; font-family: inherit; color: var(--accent-primary);
      cursor: pointer; font-weight: 600;
    }
    .modal-buttons button:first-child:not(:only-child) { border-right: 0.5px solid var(--separator-modal); font-weight: 400; }
    
    .seo-content {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid var(--separator-color);
        color: var(--text-secondary);
    }
    .seo-content h2 { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); }
    .seo-content h3 { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); margin-top: 2rem; }
    .seo-content p, .seo-content li { line-height: 1.6; }
    .seo-content a { color: var(--accent-primary); text-decoration: none; }
    .seo-content a:hover { text-decoration: underline; }
    .seo-content ul { padding-left: 1.5rem; }
    .seo-content code { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
    .faq-item { margin-bottom: 1.5rem; }
    .faq-item h4 { color: var(--text-primary); margin: 0 0 0.5rem 0; font-weight: 600; }

    @media (max-width: 768px) {
      nav { padding: 0.75rem 1rem; }
      nav .logo, nav .desktop-nav { display: none; }
      nav .nav-title-scrolled { display: block; opacity: 1; }
      #mobile-menu-trigger { display: block; }
      .content-wrapper { padding: 0 1rem 4rem; }
      header.main-header { padding: 1rem; }
      header.main-header h1 { font-size: 2rem; }
      .ios-card { border-radius: 0; margin: 0 -1rem; }
      .seo-content { margin: 4rem -1rem 0; padding: 2rem 1rem 0; border-radius: 0;}
    }
     /*
        Stile CSS v5.0 FINAL - Lista Formati Completa, Fallback Intelligente e Notifiche Toast
      */
      :root { /* Tema Scuro (Default) */
        --bg-primary: #1C1C1E;
        --bg-secondary: #2C2C2E;
        --bg-tertiary: #3A3A3C;
        --bg-modal-backdrop: rgba(0, 0, 0, 0.6);
        --bg-modal: rgba(40, 40, 42, 0.9);
        --text-primary: #FFFFFF;
        --text-secondary: #EBEBF599;
        --text-tertiary: #EBEBF566;
        --accent-primary: #0A84FF;
        --accent-secondary: #FF9F0A;
        --accent-destructive: #FF453A;
        --separator-color: #38383A;
        --separator-modal: #545458A6;
        --nav-bg: rgba(28, 28, 30, 0.8);
        --shadow-color: rgba(0, 0, 0, 0.5);
        --glow-color: rgba(10, 132, 255, 0.8);
      }
      [data-theme="light"] {
        --bg-primary: #F2F2F7;
        --bg-secondary: #FFFFFF;
        --bg-tertiary: #E5E5EA;
        --bg-modal-backdrop: rgba(0, 0, 0, 0.3);
        --bg-modal: rgba(245, 245, 247, 0.9);
        --text-primary: #000000;
        --text-secondary: #3C3C4399;
        --text-tertiary: #3C3C4366;
        --accent-primary: #007AFF;
        --accent-secondary: #FF9500;
        --accent-destructive: #FF3B30;
        --separator-color: #C6C6C8;
        --separator-modal: #3C3C434A;
        --nav-bg: rgba(249, 249, 249, 0.8);
        --shadow-color: rgba(0, 0, 0, 0.08);
        --glow-color: rgba(0, 122, 255, 0.7);
      }
      [data-theme="midnight"] {
        --bg-primary: #000000;
        --bg-secondary: #1D1D1F;
        --bg-tertiary: #2C2C2E;
        --text-primary: #FFFFFF;
        --accent-primary: #0A84FF;
        --shadow-color: rgba(0, 0, 0, 0.6);
        --nav-bg: rgba(0, 0, 0, 0.75);
      }
      [data-theme="slate"] {
        --bg-primary: #29313E;
        --bg-secondary: #354152;
        --bg-tertiary: #495867;
        --text-primary: #F7F7F7;
        --accent-primary: #F9A03F;
        --accent-destructive: #E54B4B;
        --separator-color: #495867;
        --nav-bg: rgba(25, 32, 41, 0.8);
        --glow-color: rgba(249, 160, 63, 0.7);
      }

      *, *::before, *::after { box-sizing: border-box; }
      html { scroll-behavior: smooth; }
      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        transition: background 0.4s, color 0.4s;
      }
      body.no-scroll { overflow: hidden; }

      @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 var(--glow-color); } 70% { box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); } }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
      @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      @keyframes slideInDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes glow-border {
        0%, 100% { box-shadow: 0 0 5px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--accent-primary); }
        50% { box-shadow: 0 0 20px var(--glow-color), inset 0 0 10px var(--glow-color); border-color: var(--accent-primary); }
      }
      @keyframes progressGlow {
        0% { box-shadow: 0 0 5px var(--accent-primary); }
        50% { box-shadow: 0 0 20px var(--accent-primary); }
        100% { box-shadow: 0 0 5px var(--accent-primary); }
      }
      
      nav {
        background: var(--nav-bg);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border-bottom: 0.5px solid var(--separator-color);
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 20;
      }
      nav .logo { 
        font-weight: 600; 
        color: var(--text-primary); 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
      }
      nav .logo img {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        object-fit: cover;
      }
      nav .nav-title-scrolled {
        font-weight: 600;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
      nav .desktop-nav { display: flex; gap: 1.5rem; list-style: none; margin: 0; padding: 0; }
      nav a { color: var(--accent-primary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
      nav a:hover { color: var(--text-primary); }
      nav a.active { color: var(--text-primary); font-weight: 600; }
      .nav-controls { display: flex; align-items: center; gap: 0.75rem; }
      
      #mobile-menu-trigger, #mobile-menu-close {
        display: none; background: none; border: none; cursor: pointer;
        padding: 0.5rem; color: var(--accent-primary); z-index: 110;
      }
      #mobile-menu-close { position: absolute; top: 1rem; right: 1.5rem; }
      #mobile-menu-trigger svg, #mobile-menu-close svg { width: 28px; height: 28px; }

      .mobile-nav {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-modal);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        z-index: 100; display: flex; flex-direction: column;
        padding: 6rem 1.5rem 2rem;
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      }
      .mobile-nav.active { transform: translateX(0); }
      .mobile-nav ul { list-style: none; padding: 0; margin: 0; width: 100%; }
      .mobile-nav ul a {
        display: flex; align-items: center; gap: 1rem; font-size: 1.25rem; padding: 1rem;
        color: var(--text-primary); font-weight: 500; border-bottom: 0.5px solid var(--separator-color);
      }
      .mobile-nav ul a svg { width: 24px; height: 24px; color: var(--accent-primary); }
      .mobile-nav ul li:first-child a { border-top: 0.5px solid var(--separator-color); }
      .mobile-nav .nav-controls { margin-top: auto; justify-content: center; width: 100%; display: flex; gap: 1rem; }
      
      .content-wrapper { max-width: 800px; margin: 0 auto; padding: 0 1.5rem 4rem; }
      header.main-header { padding-top: 1rem; }
      header.main-header h1 { font-size: 2.5rem; font-weight: 700; margin: 0; transition: opacity 0.2s ease-in-out; }
      p.description { margin: 0.5rem 0 2.5rem 0; color: var(--text-secondary); line-height: 1.5; font-size: 1.1rem; }
      
      .ios-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: 0 4px 20px var(--shadow-color);
        transition: background 0.4s, box-shadow 0.4s;
      }
      .ios-list > * { padding: 1rem 1.25rem; }
      .ios-list > :not(:last-child) { border-bottom: 0.5px solid var(--separator-color); }
      .ios-list label { display: flex; justify-content: space-between; align-items: center; font-weight: 500; }

      #dropZone {
        border: 2px dashed var(--bg-tertiary); border-radius: 18px; padding: 3rem 1rem; text-align: center;
        color: var(--text-secondary); cursor: pointer; transition: all 0.3s ease-in-out; margin: 1.5rem; position: relative;
      }
      #dropZone:hover { border-color: var(--accent-primary); background: var(--bg-tertiary); }
      #dropZone.drag-glow { border-style: solid; animation: glow-border 1.5s infinite; }
      #dropZone .upload-icon { width: 40px; height: 40px; margin-bottom: 1rem; color: var(--text-secondary); transition: color 0.2s; }
      #dropZone:hover .upload-icon { color: var(--accent-primary); }
      #dropZone p { margin: 0; font-weight: 500; }
      #dropZone p span { color: var(--accent-primary); font-weight: 600; }
      input[type="file"] { display: none; }
      
      select {
        padding: 0.7rem 1rem; border-radius: 8px; border: none; font-weight: 500; cursor: pointer;
        background-color: var(--bg-tertiary); color: var(--text-primary); font-family: inherit; font-size: 1rem;
        -webkit-appearance: none; appearance: none; transition: background 0.4s;
      }
      select#outputFormat { max-height: 150px; overflow-y: auto; text-align: right; }
      
      button#convertBtn {
        width: 100%; border: none; background: var(--accent-primary); color: white; font-size: 1.1rem;
        font-weight: 600; padding: 0.9rem; border-radius: 8px; cursor: pointer;
        transition: transform 0.2s, filter 0.2s; position: relative; overflow: hidden;
      }
      button#convertBtn:hover { filter: brightness(1.1); }
      button#convertBtn:active { transform: scale(0.98); }
      button#convertBtn.pulsing { animation: pulse-glow 2s infinite; }
      button#convertBtn:disabled { opacity: 0.6; cursor: not-allowed; }

      /* Progress Bar Styles */
      .progress-container {
        position: relative;
        width: 100%;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: 2px;
        margin: 1rem 0;
        overflow: hidden;
        display: none;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
        animation: progressGlow 2s infinite;
      }
      .progress-text {
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
        display: none;
      }

      #previewContainer { display: flex; flex-wrap: wrap; gap: 15px; padding: 1.5rem; justify-content: center; }
      #previewContainer img { height: 120px; border-radius: 12px; object-fit: contain; animation: fadeInUp 0.5s cubic-bezier(0.25, 1, 0.5, 1) both; }
      
      #resultContainer { margin-top: 2rem; }
      #resultContainer .ios-card { padding: 1rem; text-align: center; animation: fadeInUp 0.5s; }
      #resultContainer img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 1rem; }
      #resultContainer a { font-weight: 500; color: var(--accent-primary); text-decoration: none; font-size: 1.1rem; }

      #toastContainer {
          position: fixed;
          top: calc(env(safe-area-inset-top, 0) + 1rem);
          left: 50%;
          transform: translateX(-50%);
          z-index: 300;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
          width: fit-content;
          max-width: 90%;
      }
      .toast {
        display: flex; align-items: center; gap: 0.75rem; color: var(--text-primary); background: var(--bg-modal);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        padding: 0.8rem 1.2rem; border-radius: 50px; font-size: 0.9rem; font-weight: 500;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        animation: slideInDown 0.4s cubic-bezier(0.25, 1, 0.5, 1), fadeOut 0.4s 4.5s forwards;
      }
      .toast svg { width: 20px; height: 20px; color: var(--accent-secondary); }

      .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-modal-backdrop);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 200; display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        animation: fadeIn 0.3s;
      }
      .modal-backdrop.visible { opacity: 1; visibility: visible; }
      .modal-dialog {
        background: var(--bg-modal); border-radius: 14px; text-align: center;
        max-width: 280px; width: 90%; padding-top: 1.25rem;
        animation: zoomIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      }
      .modal-dialog h3 { margin: 0 1rem 0.5rem; font-size: 1.1rem; font-weight: 600; }
      .modal-dialog p { margin: 0 1rem 1.25rem; font-size: 0.9rem; color: var(--text-secondary); }
      .modal-buttons { display: flex; border-top: 0.5px solid var(--separator-modal); }
      .modal-buttons button {
        flex: 1; background: none; border: none; padding: 0.8rem;
        font-size: 1.1rem; font-family: inherit; color: var(--accent-primary);
        cursor: pointer; font-weight: 600;
      }
      .modal-buttons button:first-child:not(:only-child) { border-right: 0.5px solid var(--separator-modal); font-weight: 400; }
      
      .seo-content {
          margin-top: 4rem;
          padding-top: 2rem;
          border-top: 1px solid var(--separator-color);
          color: var(--text-secondary);
      }
      .seo-content h2 { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); }
      .seo-content h3 { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); margin-top: 2rem; }
      .seo-content p, .seo-content li { line-height: 1.6; }
      .seo-content a { color: var(--accent-primary); text-decoration: none; }
      .seo-content a:hover { text-decoration: underline; }
      .seo-content ul { padding-left: 1.5rem; }
      .seo-content code { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
      .faq-item { margin-bottom: 1.5rem; }
      .faq-item h4 { color: var(--text-primary); margin: 0 0 0.5rem 0; font-weight: 600; }

      @media (max-width: 768px) {
        nav { padding: 0.75rem 1rem; }
        nav .logo, nav .desktop-nav { display: none; }
        nav .nav-title-scrolled { display: block; opacity: 1; }
        #mobile-menu-trigger { display: block; }
        .content-wrapper { padding: 0 1rem 4rem; }
        header.main-header { padding: 1rem; }
        header.main-header h1 { font-size: 2rem; }
        .ios-card { border-radius: 0; margin: 0 -1rem; }
        .seo-content { margin: 4rem -1rem 0; padding: 2rem 1rem 0; border-radius: 0;}
      }
  </style>
</head>
<body>

<div id="mobileNav" class="mobile-nav">
  <button id="mobile-menu-close" title="Chiudi Menu">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.607a1 1 0 010-1.414z"/></svg>
  </button>
  <ul>
    <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg> <span data-translate-key="navConvert">Converti</span></a></li>
    <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> <span data-translate-key="navResize">Ridimensiona</span></a></li>
    <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 002 2h15"></path><path d="M1 6.13L16 6a2 2 0 012 2v15"></path></svg> <span data-translate-key="navCrop">Ritaglia</span></a></li>
    <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"></path></svg> <span data-translate-key="navRotate">Ruota</span></a></li>
    <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3l-9 9h6v9h6v-9h6z"></path></svg> <span data-translate-key="navFilters">Filtri</span></a></li>
  </ul>
  <div class="nav-controls">
      <select id="themeSelectorMobile"></select>
      <select id="langSelectorMobile"></select>
  </div>
</div>

<nav>
      <div class="logo">
        <img src="https://images.pexels.com/photos/4164418/pexels-photo-4164418.jpeg?auto=compress&cs=tinysrgb&w=64&h=64&dpr=2" alt="WebToolbox Logo" />
        üß∞ WebToolbox
      </div>

      <div class="nav-title-scrolled" data-translate-key="mainTitle">
        Convertitore Immagini
      </div>

      <!-- Nav desktop -->
      <ul class="desktop-nav">
        <li><a href="index.html" class="active">Converti</a></li>
        <li><a href="ridimensiona.html">Ridimensiona</a></li>
        <li><a href="ruota-immagini.html">Ruota</a></li>
        <li><a href="flip-immagini.html">Specchia</a></li>
        <li><a href="crop-immagini.html">Ritaglia</a></li>
        <li><a href="base64.html">Base64</a></li>
        <li><a href="scala-grigi.html">Filtri</a></li>
        <li><a href="weight.html">Converti Peso</a></li>
        <li><a href="share.html">Condividi</a></li>
      </ul>

      <!-- Controls desktop -->
      <div class="nav-controls">
        <select id="themeSelector" title="Seleziona Tema">
          <option value="dark">Scuro</option>
          <option value="light">Chiaro</option>
          <option value="midnight">Midnight</option>
          <option value="slate">Slate</option>
        </select>
      </div>

      <!-- Trigger mobile -->
      <button id="mobile-menu-trigger" title="Apri Menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
      </button>
    </nav>

    <!-- Mobile nav -->
    <div class="mobile-nav" id="mobileMenu">
      <button id="mobile-menu-close" title="Chiudi Menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>

      <ul>
        <li><a href="index.html" class="active">Converti</a></li>
        <li><a href="ridimensiona.html">Ridimensiona</a></li>
        <li><a href="ruota-immagini.html">Ruota</a></li>
        <li><a href="flip-immagini.html">Specchia</a></li>
        <li><a href="crop-immagini.html">Ritaglia</a></li>
        <li><a href="base64.html">Base64</a></li>
        <li><a href="scala-grigi.html">Filtri</a></li>
        <li><a href="weight.html">Converti Peso</a></li>
        <li><a href="share.html">Condividi</a></li>
      </ul>

      <!-- Controls mobile -->
      <div class="nav-controls">
        <select id="themeSelectorMobile" title="Seleziona Tema">
          <option value="dark">Scuro</option>
          <option value="light">Chiaro</option>
          <option value="midnight">Midnight</option>
          <option value="slate">Slate</option>
        </select>
      </div>
    </div>
<div class="content-wrapper">
  <header class="main-header">
    <h1 id="mainTitle" data-translate-key="mainTitle">Convertitore Immagini</h1>
  </header>
  <main>
    <p class="description" data-translate-key="description">Trascina le tue immagini, scegli un formato e convertile all'istante. Un'esperienza di conversione potente, racchiusa in un design pulito e intuitivo.</p>

    <div class="ios-card">
      <div id="dropZone">
          <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          <p><span data-translate-key="dropZoneText">Trascina i file qui o</span> <span data-translate-key="dropZoneTextClick">clicca per selezionare</span></p>
      </div>
      <input type="file" id="inputFiles" accept="image/*" multiple />
      
      <div class="ios-list">
        <label for="outputFormat">
          <span data-translate-key="targetFormatLabel">Formato di destinazione</span>
          <select id="outputFormat">
    <option value="jpeg">JPEG (.jpg, .jpeg)</option>
    <option value="png">PNG (.png)</option>
    <option value="webp">WebP (.webp)</option>
    <option value="bmp">BMP (.bmp)</option>
</select>

        </label>
        <div>
          <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="progress-text" id="progressText"></div>
          <button id="convertBtn" data-translate-key="convertBtn">Converti</button>
        </div>
      </div>
    </div>
    
    <div id="previewContainer" aria-live="polite"></div>
    <div id="resultContainer"></div>
  </main>

  <section class="seo-content">
      <h2 data-translate-key="seoTitle1">Il Tuo Convertitore di Immagini Online Definitivo</h2>
      <p data-translate-key="seoIntro1">Nel mondo digitale di oggi, le immagini sono tutto. Che tu sia un web developer che ottimizza i tempi di caricamento, un social media manager che crea contenuti virali, o un fotografo che archivia i propri scatti, la gestione dei formati di immagine √® cruciale. Il nostro strumento gratuito ti offre la flessibilit√† di convertire le immagini in formati moderni come WebP, standard come JPEG e PNG, e altri ancora, direttamente dal tuo browser, senza installare nulla e nel pieno rispetto della tua privacy.</p>
      
      <h3 data-translate-key="seoTitle2">Perch√© Convertire le Immagini?</h3>
      <p data-translate-key="seoIntro2">Ogni formato ha i suoi punti di forza. La conversione ti permette di scegliere il formato giusto per ogni esigenza, bilanciando qualit√† e peso del file.</p>
      <ul>
        <li data-translate-key="seoPoint1">Ottimizzazione per il Web: Converti in WebP per ridurre drasticamente il peso delle immagini senza perdere qualit√†, migliorando la velocit√† del tuo sito e la SEO.</li>
        <li data-translate-key="seoPoint2">Compatibilit√†: Assicurati che le tue immagini siano visualizzabili su ogni dispositivo e piattaforma convertendole in formati universalmente supportati come JPEG o PNG.</li>
        <li data-translate-key="seoPoint3">Trasparenza e Qualit√†: Usa il formato PNG quando hai bisogno di sfondi trasparenti o di una compressione senza perdita di dati per loghi e grafiche.</li>
      </ul>

      <h3 data-translate-key="seoTitle3">Guida ai Formati di Immagine</h3>
      <div class="format-guide">
          <p><strong><span data-translate-key="seoFormatWebP">WebP</span></strong>: <span data-translate-key="seoDescWebP">Un formato moderno di Google che offre compressione superiore (sia con che senza perdita) rispetto a JPEG e PNG. Ideale per il web.</span></p>
          <p><strong><span data-translate-key="seoFormatJPEG">JPEG</span></strong>: <span data-translate-key="seoDescJPEG">Il re della fotografia digitale. Offre un'ottima compressione con perdita, ideale per foto complesse con milioni di colori.</span></p>
          <p><strong><span data-translate-key="seoFormatPNG">PNG</span></strong>: <span data-translate-key="seoDescPNG">Perfetto per grafiche, loghi e immagini che richiedono uno sfondo trasparente. Utilizza una compressione senza perdita di qualit√†.</span></p>
          <p><strong><span data-translate-key="seoFormatTIFF">TIFF</span></strong>: <span data-translate-key="seoDescTIFF">Un formato di alta qualit√†, spesso non compresso, usato in fotografia professionale e stampa. Non √® ideale per il web a causa delle grandi dimensioni dei file.</span></p>
      </div>

      <h3 data-translate-key="seoTitle4">Domande Frequenti (FAQ)</h3>
      <div class="faq">
          <div class="faq-item">
              <h4 data-translate-key="seoFaq1Title">La conversione delle immagini √® sicura?</h4>
              <p data-translate-key="seoFaq1Desc">Assolutamente. Tutte le conversioni avvengono localmente nel tuo browser. Nessun file viene caricato sui nostri server, garantendo la massima privacy e sicurezza.</p>
          </div>
          <div class="faq-item">
              <h4 data-translate-key="seoFaq2Title">Posso convertire pi√π immagini contemporaneamente?</h4>
              <p data-translate-key="seoFaq2Desc">S√¨, il nostro strumento √® progettato per la conversione multipla. Trascina tutti i file che desideri, seleziona il formato e convertili tutti in una volta.</p>
          </div>
          <div class="faq-item">
              <h4 data-translate-key="seoFaq3Title">Perder√≤ qualit√† durante la conversione?</h4>
              <p data-translate-key="seoFaq3Desc">Dipende dai formati. La conversione verso un formato 'lossy' (con perdita) come JPEG implica sempre una minima perdita di qualit√† per ridurre le dimensioni. La conversione a formati 'lossless' (senza perdita) come PNG preserver√† la qualit√† originale.</p>
          </div>
      </div>
    </section>
</div>

<div id="toastContainer"></div>

<div id="customModal" class="modal-backdrop">
  <div class="modal-dialog">
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <div class="modal-buttons">
      <button id="modalOkBtn">OK</button>
    </div>
  </div>
</div>

<!-- UTIF Library for TIFF support -->
<script src="https://cdn.jsdelivr.net/npm/utif@4.6.0/UTIF.min.js"></script>
<!-- JSZip for file compression -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
     document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const mobileMenu = document.getElementById("mobileMenu");
        const mobileTrigger = document.getElementById("mobile-menu-trigger");
        const mobileClose = document.getElementById("mobile-menu-close");

        // Apri menu
        mobileTrigger.addEventListener("click", () => {
          mobileMenu.classList.add("active");
          body.classList.add("no-scroll");
        });

        // Chiudi menu
        mobileClose.addEventListener("click", () => {
          mobileMenu.classList.remove("active");
          body.classList.remove("no-scroll");
        });

        // Cambia tema
        function applyTheme(theme) {
          document.documentElement.setAttribute("data-theme", theme);
          localStorage.setItem("theme", theme);
          document.getElementById("themeSelector").value = theme;
          document.getElementById("themeSelectorMobile").value = theme;
        }

        document.getElementById("themeSelector").addEventListener("change", (e) => applyTheme(e.target.value));
        document.getElementById("themeSelectorMobile").addEventListener("change", (e) => applyTheme(e.target.value));

        // Carica tema salvato
        const savedTheme = localStorage.getItem("theme") || "dark";
        applyTheme(savedTheme);

        // Chiudi menu mobile quando clicchi su overlay o link
        document.addEventListener("click", (e) => {
          if (mobileMenu.classList.contains("active")) {
            if (e.target === mobileMenu || (!mobileMenu.contains(e.target) && e.target !== mobileTrigger)) {
              mobileMenu.classList.remove("active");
              body.classList.remove("no-scroll");
            }
          }
        });

        // Chiudi menu con ESC
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && mobileMenu.classList.contains("active")) {
            mobileMenu.classList.remove("active");
            body.classList.remove("no-scroll");
          }
        });

        // Chiudi menu automaticamente quando si ridimensiona la finestra
        window.addEventListener("resize", () => {
          if (window.innerWidth > 768 && mobileMenu.classList.contains("active")) {
            mobileMenu.classList.remove("active");
            body.classList.remove("no-scroll");
          }
        });
      });
// script.js ‚Äî versione "solo formati reali", pronta all'uso
document.addEventListener('DOMContentLoaded', () => {
  // --- DOM ---
  const dom = {
    input: document.getElementById('inputFiles'),
    outputFormat: document.getElementById('outputFormat'),
    convertBtn: document.getElementById('convertBtn'),
    dropZone: document.getElementById('dropZone'),
    preview: document.getElementById('previewContainer'),
    result: document.getElementById('resultContainer'),
    progressWrap: document.getElementById('progressContainer'),
    progressBar: document.getElementById('progressBar'),
    progressText: document.getElementById('progressText'),
    modal: document.getElementById('customModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalMessage: document.getElementById('modalMessage'),
    modalOk: document.getElementById('modalOkBtn'),
    toastContainer: document.getElementById('toastContainer')
  };

  // --- Utils UI (minimi, senza sistema traduzioni) ---
  const ensureToastContainer = () => {
    if (!dom.toastContainer) {
      const div = document.createElement('div');
      div.id = 'toastContainer';
      document.body.appendChild(div);
      dom.toastContainer = div;
    }
  };
  const showToast = (msg) => {
    ensureToastContainer();
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:.5rem;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>${msg}`;
    dom.toastContainer.appendChild(t);
    setTimeout(() => t.remove(), 4000);
  };
  const showModal = (title, message) => {
    if (!dom.modal) return alert(`${title}\n\n${message}`);
    dom.modalTitle.textContent = title;
    dom.modalMessage.textContent = message;
    dom.modal.classList.add('visible');
  };
  const hideModal = () => dom.modal && dom.modal.classList.remove('visible');
  dom.modalOk && dom.modalOk.addEventListener('click', hideModal);
  dom.modal && dom.modal.addEventListener('click', (e) => { if (e.target === dom.modal) hideModal(); });

  const showProgress = (txt = 'Conversione in corso...') => {
    if (dom.progressWrap) dom.progressWrap.style.display = 'block';
    if (dom.progressText) {
      dom.progressText.style.display = 'block';
      dom.progressText.textContent = txt;
    }
    updateProgress(0);
  };
  const hideProgress = () => {
    if (dom.progressWrap) dom.progressWrap.style.display = 'none';
    if (dom.progressText) dom.progressText.style.display = 'none';
  };
  const updateProgress = (p, txt) => {
    if (dom.progressBar) dom.progressBar.style.width = `${Math.max(0, Math.min(100, p))}%`;
    if (txt && dom.progressText) dom.progressText.textContent = txt;
  };

  // --- Supporto formati output ---
  const isWebPSupported = (() => {
    try {
      const c = document.createElement('canvas');
      return c.toDataURL && c.toDataURL('image/webp').indexOf('data:image/webp') === 0;
    } catch { return false; }
  })();

  // Inizializza il select con SOLI formati reali e supportati
  const initOutputFormats = () => {
    if (!dom.outputFormat) return;
    const opts = [
      { value: 'png', label: 'PNG (.png)' },
      { value: 'jpeg', label: 'JPEG / JPG (.jpg, .jpeg)' },
      ...(isWebPSupported ? [{ value: 'webp', label: 'WebP (.webp)' }] : []),
      { value: 'bmp', label: 'BMP (.bmp)' }
    ];
    dom.outputFormat.innerHTML = '';
    for (const o of opts) {
      const el = document.createElement('option');
      el.value = o.value;
      el.textContent = o.label;
      dom.outputFormat.appendChild(el);
    }
  };
  initOutputFormats();

  // --- Caricamento file & anteprime (solo immagini decodificabili dal browser) ---
  let loadedFiles = []; // solo file effettivamente decodificabili
  const clearPreviews = () => { if (dom.preview) dom.preview.innerHTML = ''; };

  const testDecodeImage = (file) => new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Decode fallita')); };
    img.src = url;
  });

  const handleFiles = async (fileList) => {
    loadedFiles = [];
    clearPreviews();
    if (dom.result) dom.result.innerHTML = '';
    hideProgress();

    const files = Array.from(fileList || []).filter(f => f.type.startsWith('image/'));
    if (!files.length) return;

    let idx = 0;
    for (const f of files) {
      try {
        const img = await testDecodeImage(f);
        loadedFiles.push(f);

        // anteprima
        if (dom.preview) {
          const thumb = document.createElement('img');
          // riutilizziamo un DataURL per non tenere in vita Blob URL
          const reader = new FileReader();
          reader.onload = e => {
            thumb.src = e.target.result;
            thumb.alt = f.name;
            thumb.style.animationDelay = `${idx * 0.06}s`;
            dom.preview.appendChild(thumb);
          };
          reader.readAsDataURL(f);
        }
        idx++;
      } catch {
        showToast(`Input non supportato dal browser: ${f.name}`);
      }
    }
  };

  // --- Eventi dropzone/input ---
  dom.dropZone && dom.dropZone.addEventListener('click', () => dom.input && dom.input.click());
  dom.input && dom.input.addEventListener('change', (e) => handleFiles(e.target.files));
  if (dom.dropZone) {
    ['dragover', 'dragleave', 'drop'].forEach(ev => {
      dom.dropZone.addEventListener(ev, e => {
        e.preventDefault(); e.stopPropagation();
        if (ev === 'dragover') dom.dropZone.classList.add('drag-glow');
        else dom.dropZone.classList.remove('drag-glow');
        if (ev === 'drop') handleFiles(e.dataTransfer.files);
      });
    });
  }

  // --- Converter helpers ---
  const drawOnWhite = (sourceCanvas) => {
    const c = document.createElement('canvas');
    c.width = sourceCanvas.width;
    c.height = sourceCanvas.height;
    const cx = c.getContext('2d');
    cx.fillStyle = '#ffffff';
    cx.fillRect(0, 0, c.width, c.height);
    cx.drawImage(sourceCanvas, 0, 0);
    return c;
  };

  // Crea un Blob BMP 24-bit vero (BGR, bottom-up, row padding a 4 byte)
  const canvasToBMP24 = (srcCanvas) => {
    const c = drawOnWhite(srcCanvas); // niente alpha nel BMP: flattiamo su bianco
    const w = c.width, h = c.height;
    const ctx = c.getContext('2d');
    const { data } = ctx.getImageData(0, 0, w, h);

    const rowBytes = ((w * 3 + 3) & ~3);     // 3 byte per pixel + padding a 4
    const imageSize = rowBytes * h;
    const fileSize = 54 + imageSize;         // 14 (BMP) + 40 (DIB) + data
    const buf = new ArrayBuffer(fileSize);
    const dv = new DataView(buf);
    let p = 0;

    // Header BMP (14)
    dv.setUint8(p++, 0x42); // 'B'
    dv.setUint8(p++, 0x4D); // 'M'
    dv.setUint32(p, fileSize, true); p += 4;
    dv.setUint32(p, 0, true); p += 4;       // reserved
    dv.setUint32(p, 54, true); p += 4;      // data offset

    // DIB BITMAPINFOHEADER (40)
    dv.setUint32(p, 40, true); p += 4;      // header size
    dv.setInt32(p, w, true); p += 4;
    dv.setInt32(p, h, true); p += 4;        // positivo = bottom-up
    dv.setUint16(p, 1, true); p += 2;       // planes
    dv.setUint16(p, 24, true); p += 2;      // bpp
    dv.setUint32(p, 0, true); p += 4;       // BI_RGB (no compression)
    dv.setUint32(p, imageSize, true); p += 4;
    dv.setInt32(p, 2835, true); p += 4;     // ~72 DPI
    dv.setInt32(p, 2835, true); p += 4;
    dv.setUint32(p, 0, true); p += 4;       // colors used
    dv.setUint32(p, 0, true); p += 4;       // important colors

    // Pixel data (B,G,R) bottom-up
    let offset = 54;
    const pad = rowBytes - w * 3;
    for (let y = h - 1; y >= 0; y--) {
      const rowStart = y * w * 4;
      for (let x = 0; x < w; x++) {
        const i = rowStart + x * 4;
        const r = data[i], g = data[i + 1], b = data[i + 2];
        dv.setUint8(offset++, b);
        dv.setUint8(offset++, g);
        dv.setUint8(offset++, r);
      }
      for (let k = 0; k < pad; k++) dv.setUint8(offset++, 0);
    }
    return new Blob([buf], { type: 'image/bmp' });
  };

  // Converters reali
  const converters = {
    png: async (canvas) => new Promise(res => canvas.toBlob(res, 'image/png')),
    jpeg: async (canvas, quality = 0.92) => new Promise(res => drawOnWhite(canvas).toBlob(res, 'image/jpeg', quality)),
    jpg: async (canvas, quality = 0.92) => converters.jpeg(canvas, quality),
    webp: async (canvas, quality = 0.92) => {
      if (!isWebPSupported) throw new Error('WebP non supportato');
      return new Promise(res => canvas.toBlob(res, 'image/webp', quality));
    },
    bmp: async (canvas) => canvasToBMP24(canvas)
  };

  const extMap = { png: 'png', jpeg: 'jpg', jpg: 'jpg', webp: 'webp', bmp: 'bmp' };

  // --- Processo singolo file ---
  const processFile = (file, targetFormat) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth || img.width;
          canvas.height = img.naturalHeight || img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          const fn = converters[targetFormat] || converters.png; // sicurezza
          const blob = await fn(canvas);
          const url = URL.createObjectURL(blob);
          const ext = extMap[targetFormat] || 'png';
          const filename = file.name.replace(/\.[^/.]+$/, `.${ext}`);
          resolve({ url, filename });
        } catch (e) {
          reject(e);
        }
      };
      img.onerror = () => reject(new Error('Immagine non decodificabile'));
      img.src = reader.result;
    };
    reader.onerror = () => reject(new Error('Lettura file fallita'));
    reader.readAsDataURL(file);
  });

  // --- Azione converti ---
  dom.convertBtn && dom.convertBtn.addEventListener('click', async () => {
    if (!loadedFiles.length) {
      showModal('Nessun file', 'Seleziona almeno un\'immagine prima di procedere.');
      return;
    }
    const fmt = dom.outputFormat ? dom.outputFormat.value : 'png';

    dom.convertBtn.disabled = true;
    showProgress('Conversione in corso...');
    if (dom.result) dom.result.innerHTML = '';

    const total = loadedFiles.length;
    let done = 0;

    // wrapper card visiva
    const card = document.createElement('div');
    card.className = 'ios-card';
    card.style.padding = '1rem';
    card.style.textAlign = 'center';
    if (dom.result) dom.result.appendChild(card);

    for (const file of loadedFiles) {
      updateProgress((done / total) * 100, `Elaboro: ${file.name}`);
      try {
        const out = await processFile(file, fmt);
        const item = document.createElement('div');
        item.style.marginBottom = '1rem';
        item.innerHTML = `
          <img src="${out.url}" alt="Anteprima" style="max-width:100%;max-height:200px;border-radius:8px;margin-bottom:.75rem;">
          <br>
          <a href="${out.url}" download="${out.filename}" style="font-weight:600;text-decoration:none;">
            Scarica ${out.filename}
          </a>
        `;
        card.appendChild(item);
      } catch (e) {
        console.error(e);
        showToast(`Impossibile convertire ${file.name} ‚Üí ${fmt}. Salvato niente.`);
      }
      done++;
      updateProgress((done / total) * 100);
    }

    updateProgress(100, 'Fatto!');
    setTimeout(() => { hideProgress(); dom.convertBtn.disabled = false; }, 800);
  });

  // --- piccoli extra UX ---
  // spinta visiva sul bottone quando ci sono file validi
  const maybePulseBtn = () => {
    if (!dom.convertBtn) return;
    dom.convertBtn.classList.remove('pulsing');
    if (loadedFiles.length) setTimeout(() => dom.convertBtn.classList.add('pulsing'), 350);
  };

  // ricarica file e attiva pulsazione
  const bindHandleFiles = async (files) => {
    await handleFiles(files);
    maybePulseBtn();
  };

  // collega ai listener gi√† creati
  if (dom.input) dom.input.addEventListener('change', (e) => bindHandleFiles(e.target.files));
  if (dom.dropZone) dom.dropZone.addEventListener('drop', (e) => { e.preventDefault(); bindHandleFiles(e.dataTransfer.files); });

  // Se la pagina aveva gi√† opzioni fake nel <select>, le eliminiamo comunque ora.
  initOutputFormats();
});

</script>

</body>
</html>
