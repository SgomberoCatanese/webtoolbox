<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Specchia e Ruota Immagini Online – WebToolbox.fun</title>
<meta name="description" content="Specchia immagini orizzontalmente, verticalmente, doppia e ruota di 90, 180, 270 gradi o personalizzato. Supporto multiplo, download singolo e ZIP." />
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 0; padding: 0 1rem;
  }
  nav {
    background: #1db954;
    padding: 1rem;
    display: flex; flex-wrap: wrap; justify-content: space-between;
  }
  nav .logo {
    font-weight: bold;
    font-size: 1.4rem;
    color: #121212;
  }
  nav ul {
    list-style: none;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 0;
    padding: 0;
  }
  nav a {
    text-decoration: none;
    color: #121212;
    font-weight: bold;
  }
  nav a.active {
    text-decoration: underline;
  }
  main {
    max-width: 900px;
    margin: 2rem auto;
    padding-bottom: 4rem;
  }
  h1, p {
    text-align: center;
  }
  #upload {
    display: block;
    margin: 1rem auto;
    max-width: 300px;
  }
  .image-container {
    margin: 1rem 0;
    background: #222;
    border-radius: 8px;
    padding: 1rem;
  }
  .image-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }
  .single-image {
    background: #111;
    border-radius: 8px;
    padding: 0.5rem;
    max-width: 280px;
    flex-grow: 1;
    box-sizing: border-box;
  }
  canvas {
    width: 100%;
    border-radius: 5px;
    display: block;
    margin-bottom: 0.5rem;
    background: #000;
  }
  label {
    display: block;
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
  }
  select, input[type=number] {
    width: 100%;
    padding: 0.3rem;
    border-radius: 5px;
    border: none;
    font-size: 0.9rem;
    margin-bottom: 0.6rem;
  }
  button {
    background: #1db954;
    border: none;
    color: #121212;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
  }
  .download-all-container {
    text-align: center;
    margin: 2rem 0 4rem;
  }
  .format-select {
    max-width: 150px;
    margin: 0 auto 1rem;
  }
  @media (max-width: 600px) {
    .image-wrapper {
      flex-direction: column;
      align-items: center;
    }
    .single-image {
      max-width: 100%;
    }
  }
</style>
</head>
<body>
<nav>
  <div class="logo">WebToolbox.fun</div>
  <ul>
    <li><a href="index.html">Converti</a></li>
    <li><a href="ridimensiona.html">Ridimensiona</a></li>
    <li><a href="ruota-immagini.html">Ruota</a></li>
    <li><a href="flip-immagini.html" class="active">Specchia</a></li>
    <li><a href="crop-immagini.html">Ritaglia</a></li>
    <li><a href="base64.html">Base64/ASCII</a></li>
    <li><a href="scala-grigi.html">Filtri</a></li>
  </ul>
</nav>

<main>
  <h1>Specchia e Ruota Immagini Online</h1>
  <p>Carica più immagini, scegli per ognuna specchiatura e rotazione, scarica singolarmente o tutte in ZIP.</p>

  <input type="file" id="upload" accept="image/*" multiple />

  <div class="download-all-container">
    <label for="allFormat">Formato download ZIP:</label>
    <select id="allFormat" class="format-select" aria-label="Formato per download zip">
      <option value="png">PNG</option>
      <option value="jpeg">JPEG</option>
    </select>
    <button id="downloadAllBtn">Scarica Tutto in ZIP</button>
  </div>

  <div class="image-wrapper" id="imageWrapper"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
  const upload = document.getElementById('upload');
  const imageWrapper = document.getElementById('imageWrapper');
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  const allFormatSelect = document.getElementById('allFormat');

  let imagesData = []; // {img, canvas, ctx, flipH, flipV, rotation, format, dataUrl}

  upload.addEventListener('change', () => {
    imagesData = [];
    imageWrapper.innerHTML = '';
    if(!upload.files.length) return;

    Array.from(upload.files).forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          const container = document.createElement('div');
          container.className = 'single-image';

          // canvas
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          // controls
          const flipHLabel = document.createElement('label');
          flipHLabel.textContent = 'Specchia Orizzontale';
          const flipHSelect = document.createElement('select');
          ['No', 'Sì'].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt === 'Sì' ? 'true' : 'false';
            option.textContent = opt;
            flipHSelect.appendChild(option);
          });
          flipHLabel.appendChild(flipHSelect);

          const flipVLabel = document.createElement('label');
          flipVLabel.textContent = 'Specchia Verticale';
          const flipVSelect = document.createElement('select');
          ['No', 'Sì'].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt === 'Sì' ? 'true' : 'false';
            option.textContent = opt;
            flipVSelect.appendChild(option);
          });
          flipVLabel.appendChild(flipVSelect);

          const rotationLabel = document.createElement('label');
          rotationLabel.textContent = 'Rotazione';
          const rotationSelect = document.createElement('select');
          ['0', '90', '180', '270', 'Personalizzato'].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.toLowerCase();
            option.textContent = opt + '°';
            rotationSelect.appendChild(option);
          });
          rotationLabel.appendChild(rotationSelect);

          const rotationCustomInput = document.createElement('input');
          rotationCustomInput.type = 'number';
          rotationCustomInput.min = '0';
          rotationCustomInput.max = '360';
          rotationCustomInput.value = '0';
          rotationCustomInput.style.display = 'none';
          rotationCustomInput.style.marginBottom = '0.6rem';

          rotationSelect.addEventListener('change', () => {
            if (rotationSelect.value === 'personalizzato') {
              rotationCustomInput.style.display = 'block';
            } else {
              rotationCustomInput.style.display = 'none';
              rotationCustomInput.value = '0';
            }
            updateCanvas();
          });

          rotationCustomInput.addEventListener('input', () => {
            updateCanvas();
          });

          // download button
          const downloadBtn = document.createElement('button');
          downloadBtn.textContent = 'Scarica Immagine';
          downloadBtn.addEventListener('click', () => {
            const fmt = formatSelect.value;
            canvas.toBlob(blob => {
              saveAs(blob, `immagine_${index+1}.${fmt}`);
            }, `image/${fmt}`);
          });

          // format selector
          const formatLabel = document.createElement('label');
          formatLabel.textContent = 'Formato Download';
          const formatSelect = document.createElement('select');
          ['png', 'jpeg'].forEach(fmt => {
            const option = document.createElement('option');
            option.value = fmt;
            option.textContent = fmt.toUpperCase();
            formatSelect.appendChild(option);
          });
          formatLabel.appendChild(formatSelect);

          // append controls
          container.appendChild(canvas);
          container.appendChild(flipHLabel);
          container.appendChild(flipVLabel);
          container.appendChild(rotationLabel);
          container.appendChild(rotationCustomInput);
          container.appendChild(formatLabel);
          container.appendChild(downloadBtn);

          imageWrapper.appendChild(container);

          // store data for this image
          const imageData = {
            img,
            canvas,
            ctx,
            flipH: false,
            flipV: false,
            rotation: 0,
            format: 'png',
            dataUrl: null
          };
          imagesData.push(imageData);

          // update canvas drawing
          function updateCanvas() {
            let rot = 0;
            if(rotationSelect.value === 'personalizzato') {
              rot = Number(rotationCustomInput.value) || 0;
            } else {
              rot = Number(rotationSelect.value) || 0;
            }
            imageData.flipH = flipHSelect.value === 'true';
            imageData.flipV = flipVSelect.value === 'true';
            imageData.rotation = rot;
            imageData.format = formatSelect.value;

            // canvas dimension change for rotation 90 or 270
            if(rot % 180 === 90 || rot % 180 === -90) {
              imageData.canvas.width = imageData.img.height;
              imageData.canvas.height = imageData.img.width;
            } else {
              imageData.canvas.width = imageData.img.width;
              imageData.canvas.height = imageData.img.height;
            }

            // clear and apply transform
            imageData.ctx.save();
            imageData.ctx.clearRect(0, 0, imageData.canvas.width, imageData.canvas.height);
            imageData.ctx.translate(imageData.canvas.width/2, imageData.canvas.height/2);
            imageData.ctx.rotate(rot * Math.PI/180);
            imageData.ctx.scale(imageData.flipH ? -1 : 1, imageData.flipV ? -1 : 1);
            imageData.ctx.drawImage(imageData.img, -imageData.img.width/2, -imageData.img.height/2);
            imageData.ctx.restore();

            // update dataURL
            imageData.dataUrl = imageData.canvas.toDataURL(`image/${imageData.format}`);
          }

          // listen controls
          [flipHSelect, flipVSelect, rotationSelect, rotationCustomInput, formatSelect].forEach(ctrl => {
            ctrl.addEventListener('change', updateCanvas);
            ctrl.addEventListener('input', updateCanvas);
          });

          // init canvas draw
          updateCanvas();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  });

  // download all ZIP
  downloadAllBtn.addEventListener('click', async () => {
    if(imagesData.length === 0) {
      alert('Carica prima almeno un\'immagine, bro!');
      return;
    }
    const zip = new JSZip();
    const chosenFormat = allFormatSelect.value;

    for(let i = 0; i < imagesData.length; i++) {
      const imageData = imagesData[i];
      // converto in blob e aggiungo
      const blob = await new Promise(resolve => {
        imageData.canvas.toBlob(resolve, `image/${chosenFormat}`);
      });
      zip.file(`immagine_${i+1}.${chosenFormat}`, blob);
    }
    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, `immagini_specchiate.zip`);
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>
